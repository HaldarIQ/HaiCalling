<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HaiCalling</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* ------------------- */
        /* --- GLOBAL STYLES & THEMES --- */
        /* ------------------- */
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --accent-color: #0f3460;
            --text-color: #e94560;
            --text-light: #f0f0f0;
            --glow-color: rgba(233, 69, 96, 0.7);
            --glass-bg: rgba(22, 33, 62, 0.6);
            --red-badge: #e94560;
        }

        body.light-mode {
            --primary-bg: #f0f8ff;
            --secondary-bg: #ffffff;
            --accent-color: #87ceeb;
            --text-color: #4682b4;
            --text-light: #333;
            --glow-color: rgba(70, 130, 180, 0.7);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --red-badge: #ff3b30;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #16213e, #0f3460, #e94560);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--text-light);
            transition: background 0.5s ease;
        }

        body.light-mode {
             background: linear-gradient(135deg, #87ceeb, #add8e6, #4682b4);
             background-size: 400% 400%;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .app-container {
            width: 100%;
            height: 100vh;
            max-width: 450px;
            max-height: 900px;
            background: var(--primary-bg);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease;
        }

        .view {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        .view.active {
            display: flex;
        }
        
        /* Glassmorphism Style */
        .glass-ui {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: background-color 0.5s ease;
        }

        /* ------------------- */
        /* --- AUTHENTICATION VIEW --- */
        /* ------------------- */
        #auth-view {
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }

        #auth-view h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 0 0 10px var(--glow-color);
            margin-bottom: 30px;
        }

        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-field {
            width: 100%;
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            background: transparent;
            color: var(--text-light);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-field::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        .input-field:focus {
            border-color: var(--text-color);
            box-shadow: 0 0 15px var(--glow-color);
        }
        
        .auth-button {
            padding: 15px;
            border-radius: 50px;
            border: none;
            background: var(--text-color);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--glow-color);
        }

        .form-switch-link {
            margin-top: 15px;
            color: var(--text-light);
            text-decoration: underline;
            cursor: pointer;
        }
        
        #auth-error {
            color: var(--red-badge);
            margin-top: 15px;
            min-height: 20px;
        }
        
        /* ------------------- */
        /* --- MAIN APP INTERFACE --- */
        /* ------------------- */
        .top-bar {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .top-bar h2 {
            font-size: 1.5rem;
            color: var(--text-light);
            font-weight: 700;
        }
        
        .top-bar-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1rem;
            cursor: pointer;
        }
        
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .content-area::-webkit-scrollbar {
            width: 5px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }
        
        .content-page {
            display: none;
        }
        
        .content-page.active {
            display: block;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: var(--secondary-bg);
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
        }
        
        .list-item:hover {
            background-color: var(--accent-color);
        }

        .list-item-emoji {
            font-size: 2rem;
            margin-right: 15px;
        }

        .list-item-details {
            flex-grow: 1;
        }
        
        .list-item-name {
            font-weight: bold;
            color: var(--text-light);
        }

        .list-item-subtext {
            color: var(--text-light);
            opacity: 0.7;
            font-size: 0.9rem;
        }
        
        .list-item-actions {
             display: flex;
             align-items: center;
             gap: 10px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        
        .accept-btn { background-color: #28a745; }
        .decline-btn { background-color: #dc3545; }

        .unread-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--red-badge);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .bottom-nav {
            width: 100%;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-light);
            opacity: 0.7;
            font-size: 1rem;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-btn.active {
            color: var(--text-color);
            opacity: 1;
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--red-badge);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ------------------- */
        /* --- CHAT VIEW --- */
        /* ------------------- */
        #chat-view {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--primary-bg);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        
        #chat-view.active {
            transform: translateX(0);
        }

        .chat-header {
            padding: 15px 10px;
            display: flex;
            align-items: center;
            background-color: var(--secondary-bg);
            flex-shrink: 0;
        }

        .chat-header .back-btn {
            background: none; border: none; color: var(--text-light); font-size: 1rem; cursor: pointer; margin-right: 10px;
        }

        .chat-contact-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--text-light);
            flex-grow: 1;
        }
        
        .call-action-btn {
             background: none; border: none; color: var(--text-light); font-size: 1rem; cursor: pointer; margin-left: 15px;
        }
        
        #messages-container {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .message-bubble.sent {
            background-color: var(--text-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message-bubble.received {
            background-color: var(--secondary-bg);
            color: var(--text-light);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .message-timestamp {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
        }
        
        .chat-input-area {
            display: flex;
            padding: 10px;
            background-color: var(--secondary-bg);
            flex-shrink: 0;
        }
        
        #message-input {
            flex-grow: 1;
            padding: 12px 20px;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            background: var(--primary-bg);
            color: var(--text-light);
            outline: none;
            font-size: 1rem;
        }

        #send-button {
            margin-left: 10px;
            padding: 0 25px;
            border-radius: 50px;
            border: none;
            background: var(--text-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* ------------------- */
        /* --- CALLING UI --- */
        /* ------------------- */
        .call-ui-view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200;
        }
        
        #call-view { background-color: #000; }
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 150px;
            border: 3px solid var(--text-color);
            border-radius: 10px;
            object-fit: cover;
            cursor: grab;
        }
        
        #audio-call-view {
             justify-content: center;
             align-items: center;
             text-align: center;
        }
        #audio-call-view::before {
             content: '';
             position: absolute;
             top: 0; left: 0; width: 100%; height: 100%;
             background: linear-gradient(135deg, #16213e, #0f3460, #e94560);
             background-size: 400% 400%;
             animation: gradientAnimation 15s ease infinite;
             z-index: -1;
        }
        body.light-mode #audio-call-view::before {
             background: linear-gradient(135deg, #87ceeb, #add8e6, #4682b4);
             background-size: 400% 400%;
        }
        
        #audio-callee-emoji { font-size: 6rem; }
        #audio-callee-name { font-size: 2rem; font-weight: bold; margin-top: 15px; }
        #audio-call-status { font-size: 1rem; opacity: 0.8; margin-top: 10px; }

        .call-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }
        
        .call-control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
        }
        
        .end-call-btn { background-color: #e94560; font-weight: bold; font-size: 1rem; }
        .speaker-btn { background-color: rgba(255, 255, 255, 0.2); }
        .speaker-btn.active { background-color: var(--accent-color); }
        .speaker-btn svg { width: 30px; height: 30px; fill: white; }

        /* ------------------- */
        /* --- MODALS --- */
        /* ------------------- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            width: 90%;
            max-width: 350px;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-content h3 {
            color: var(--text-color);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .modal-content p {
            color: var(--text-light);
            opacity: 0.9;
        }

        .modal-btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 50px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-btn.primary { background-color: var(--text-color); }
        .modal-btn.secondary { background-color: var(--accent-color); }
        
        #incoming-call-modal .modal-content {
            text-align: center;
        }
        
        #incoming-call-emoji { font-size: 4rem; }
        
        .menu-list {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .menu-item {
            padding: 15px 20px;
            background-color: transparent;
            border: none;
            color: var(--text-light);
            font-size: 1.1rem;
            text-align: left;
            cursor: pointer;
            width: 100%;
            border-bottom: 1px solid var(--accent-color);
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        .menu-item:hover {
            background-color: var(--accent-color);
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- ======================= -->
        <!-- ==== AUTHENTICATION VIEW ==== -->
        <!-- ======================= -->
        <div id="auth-view" class="view active">
            <h1>HaiCalling</h1>
            
            <div id="login-form" class="auth-form">
                <input type="email" id="login-email" class="input-field" placeholder="Email">
                <input type="password" id="login-password" class="input-field" placeholder="Password">
                <button id="login-button" class="auth-button">Log In</button>
                <p id="auth-error"></p>
                <a class="form-switch-link" id="show-signup">Don't have an account? Sign Up</a>
            </div>

            <div id="signup-form" class="auth-form" style="display: none;">
                <input type="email" id="signup-email" class="input-field" placeholder="Email">
                <input type="password" id="signup-password" class="input-field" placeholder="Password">
                <button id="signup-button" class="auth-button">Sign Up</button>
                <p id="auth-error-signup"></p>
                <a class="form-switch-link" id="show-login">Already have an account? Log In</a>
            </div>
        </div>

        <!-- ======================= -->
        <!-- ==== MAIN APP VIEW ==== -->
        <!-- ======================= -->
        <div id="main-app-view" class="view">
            <header class="top-bar glass-ui">
                <button class="top-bar-btn" id="menu-btn">Menu</button>
                <h2 id="main-title">HaiCalling</h2>
                <button class="top-bar-btn" id="add-friend-btn">Add Friend</button>
            </header>
            
            <main class="content-area">
                <div id="home-page" class="content-page active">
                    <!-- Contact list will be dynamically generated here -->
                </div>
                <div id="notifications-page" class="content-page">
                    <!-- Notifications and friend requests will be here -->
                </div>
                <div id="calls-page" class="content-page">
                    <!-- Call history will be here -->
                </div>
            </main>

            <nav class="bottom-nav glass-ui">
                <button class="nav-btn active" data-page="home-page">Home</button>
                <button class="nav-btn" data-page="notifications-page" id="notifications-nav-btn">
                    Notifications
                    <span id="notifications-badge" class="nav-badge" style="display: none;"></span>
                </button>
                <button class="nav-btn" data-page="calls-page">Calls</button>
            </nav>
        </div>
        
        <!-- ======================= -->
        <!-- ==== CHAT VIEW ==== -->
        <!-- ======================= -->
        <div id="chat-view" class="view">
            <header class="chat-header">
                <button class="back-btn" id="chat-back-btn">Back</button>
                <span id="chat-contact-name" class="chat-contact-name">Contact Name</span>
                <button class="call-action-btn" id="voice-call-btn">Voice</button>
                <button class="call-action-btn" id="video-call-btn">Video</button>
            </header>
            <div id="messages-container-wrapper" style="flex-grow: 1; overflow-y: auto; display:flex; flex-direction:column-reverse;">
                 <div id="messages-container">
                    <!-- Messages will be dynamically inserted here -->
                 </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-button">Send</button>
            </div>
        </div>

    </div>
    
    <!-- ======================= -->
    <!-- ==== VIDEO CALL VIEW ==== -->
    <!-- ======================= -->
    <div id="call-view" class="view call-ui-view">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-controls">
            <button class="call-control-btn end-call-btn" id="end-video-call-btn">End</button>
        </div>
    </div>
    
    <!-- ======================= -->
    <!-- ==== AUDIO CALL VIEW ==== -->
    <!-- ======================= -->
    <div id="audio-call-view" class="view call-ui-view">
        <div id="audio-callee-emoji"></div>
        <div id="audio-callee-name"></div>
        <div id="audio-call-status"></div>
        <div class="call-controls">
            <button class="call-control-btn speaker-btn" id="speaker-btn">
                <svg viewBox="0 0 24 24">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path>
                </svg>
            </button>
            <button class="call-control-btn end-call-btn" id="end-audio-call-btn">End</button>
        </div>
    </div>

    <!-- ======================= -->
    <!-- ==== MODALS ==== -->
    <!-- ======================= -->
    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <h3>Welcome to HaiCalling!</h3>
            <p>Please set up your profile.</p>
            <input type="text" id="user-name-input" class="input-field" placeholder="Your Name">
            <input type="text" id="user-emoji-input" class="input-field" placeholder="Your Emoji (e.g., 😊)">
            <div class="modal-btn-group">
                <button id="save-user-details-btn" class="modal-btn primary">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <h3>Add a Friend</h3>
            <p>Enter your friend's HaiCalling ID (e.g., hai-xxxx).</p>
            <input type="text" id="friend-id-input" class="input-field" placeholder="hai-xxxx">
            <div id="friend-search-result" style="margin-top: 15px;"></div>
            <div class="modal-btn-group">
                 <button id="search-friend-btn" class="modal-btn primary">Search</button>
                 <button class="modal-btn secondary" data-close>Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Incoming Call Modal -->
    <div id="incoming-call-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <div id="incoming-call-emoji" style="font-size: 4rem;"></div>
            <h3 id="incoming-call-name"></h3>
            <p id="incoming-call-type"></p>
            <div class="modal-btn-group">
                <button id="accept-call-btn" class="modal-btn" style="background-color: #28a745;">Accept</button>
                <button id="reject-call-btn" class="modal-btn" style="background-color: #dc3545;">Reject</button>
            </div>
        </div>
    </div>
    
    <!-- Main Menu Modal -->
    <div id="menu-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <div class="menu-list">
                 <button class="menu-item" id="menu-profile-btn">Profile</button>
                 <button class="menu-item" id="menu-blocked-btn">Blocked Users</button>
                 <button class="menu-item" id="menu-theme-btn">Toggle Theme</button>
                 <button class="menu-item" id="menu-logout-btn" style="color: var(--text-color);">Logout</button>
                 <button class="menu-item" data-close>Close Menu</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <h3>Your Profile</h3>
            <p id="profile-id-display"></p>
            <input type="text" id="profile-name-input" class="input-field">
            <input type="text" id="profile-emoji-input" class="input-field">
            <div class="modal-btn-group">
                 <button id="save-profile-btn" class="modal-btn primary">Save</button>
                 <button class="modal-btn secondary" data-close>Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Blocked Users Modal -->
    <div id="blocked-users-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <h3>Blocked Users</h3>
            <div id="blocked-users-list" style="max-height: 200px; overflow-y: auto; width: 100%;"></div>
            <div class="modal-btn-group">
                 <button class="modal-btn secondary" data-close>Close</button>
            </div>
        </div>
    </div>
    
    <!-- Generic Alert Modal -->
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
            <h3 id="alert-title">Alert</h3>
            <p id="alert-message"></p>
            <div class="modal-btn-group">
                <button class="modal-btn primary" data-close>OK</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Options Modal -->
    <div id="contact-options-modal" class="modal-overlay">
        <div class="modal-content glass-ui">
             <h3 id="contact-options-name"></h3>
             <div class="menu-list">
                 <button class="menu-item" id="contact-block-btn" style="color: var(--text-color);">Block User</button>
                 <button class="menu-item" id="contact-delete-chat-btn" style="color: var(--text-color);">Delete Chat</button>
                 <button class="menu-item" data-close>Cancel</button>
             </div>
        </div>
    </div>

    <!-- Ringtones and Sounds -->
    <audio id="incoming-call-audio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" loop></audio>
    <audio id="message-tone-audio" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU9vT19PAAC2e/j9+fT+5/v/8/r/4/sA9vr//fD99v7/+f4A/Pn7/v78+fj6+vj1+Pb5//z2+f/6+v3/+vn5/vz6+f77/vz/+v7/+v3/+/z9/Pz6/P/6+v78/f79/v7/+fn+9/3/+vv9/fn99/z/+v3/+/7/+//7/v3+9/3//f79/vv9/f7/+vz+9vz/+v/+/P/++/3//v3/+/z/+vz9+fn++/7++/7++/79/P38/f78/v3++/79/v3+/P3+/f/6/v7+/f37/vv+9/7/+/7/+v3/+/z9+/v9/vv9+Pv8/v/8/v/6/vv++v7/+v/+/f/6/v7/+vv9/v3/+/7++/z/+v7++/79/v7/+v3/+v3/+v7/+/79+/7+///++/7//v/8/v/++/7//v3/+/z/+v/+/v/6/v/++/7//v3/+/7++/7/+v3/+v/7/vv+"></audio>
    
    <script>
    (() => {
        // TODO: PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
  apiKey: "AIzaSyAD2S8b5dxYV1fFYc-RMJMwV1IQ3yCRvd0",
  authDomain: "haicalling.firebaseapp.com",
  databaseURL: "https://haicalling-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "haicalling",
  storageBucket: "haicalling.firebasestorage.app",
  messagingSenderId: "379823659600",
  appId: "1:379823659600:web:d86fb74951ce52206b4f55"
};

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- Global State ---
        let currentUser = null;
        let currentChatId = null;
        let currentChatPeer = null;
        let messageListeners = {};
        let unreadListeners = {};
        let callListeners = {};
        let peerConnection;
        let localStream;
        let remoteStream;
        let currentCallData;
        let isSpeakerOn = false;
        
        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const chatView = document.getElementById('chat-view');
        const callView = document.getElementById('call-view');
        const audioCallView = document.getElementById('audio-call-view');
        
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authError = document.getElementById('auth-error');
        const authErrorSignup = document.getElementById('auth-error-signup');
        
        const homePage = document.getElementById('home-page');
        const notificationsPage = document.getElementById('notifications-page');
        const callsPage = document.getElementById('calls-page');
        const bottomNavBtns = document.querySelectorAll('.nav-btn');
        const notificationsBadge = document.getElementById('notifications-badge');

        const messagesContainer = document.getElementById('messages-container');
        
        // Modals
        const userDetailsModal = document.getElementById('user-details-modal');
        const addFriendModal = document.getElementById('add-friend-modal');
        const incomingCallModal = document.getElementById('incoming-call-modal');
        const menuModal = document.getElementById('menu-modal');
        const profileModal = document.getElementById('profile-modal');
        const blockedUsersModal = document.getElementById('blocked-users-modal');
        const alertModal = document.getElementById('alert-modal');
        const contactOptionsModal = document.getElementById('contact-options-modal');
        
        // Audio elements
        const incomingCallAudio = document.getElementById('incoming-call-audio');
        const messageToneAudio = document.getElementById('message-tone-audio');
        
        // ============================ //
        // ==== AUTHENTICATION LOGIC ==== //
        // ============================ //
        
        auth.onAuthStateChanged(user => {
            if (user) {
                const userRef = db.ref(`users/${user.uid}`);
                userRef.once('value', snapshot => {
                    if (snapshot.exists()) {
                        currentUser = { uid: user.uid, ...snapshot.val() };
                        initializeApp();
                    } else {
                        // New user, needs to create profile
                        showModal('user-details-modal');
                    }
                });
            } else {
                currentUser = null;
                cleanupApp();
                showView('auth-view');
            }
        });

        // --- Event Listeners for Auth Forms ---
        document.getElementById('show-signup').addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        document.getElementById('show-login').addEventListener('click', () => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
        });
        
        document.getElementById('login-button').addEventListener('click', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => { authError.textContent = error.message; });
        });
        
        document.getElementById('signup-button').addEventListener('click', e => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => { authErrorSignup.textContent = error.message; });
        });

        document.getElementById('save-user-details-btn').addEventListener('click', () => {
            const name = document.getElementById('user-name-input').value.trim();
            const emoji = document.getElementById('user-emoji-input').value.trim();
            if (name && emoji) {
                const user = auth.currentUser;
                const userId = `hai-${Math.random().toString(36).substr(2, 4)}`;
                const profileData = {
                    name,
                    emoji,
                    email: user.email,
                    userId,
                    callStatus: 'available'
                };
                db.ref(`users/${user.uid}`).set(profileData).then(() => {
                    currentUser = { uid: user.uid, ...profileData };
                    hideModal('user-details-modal');
                    initializeApp();
                });
            }
        });

        // ============================ //
        // ======== APP LOGIC ========= //
        // ============================ //
        
        function initializeApp() {
            showView('main-app-view');
            setupPresence();
            loadContacts();
            loadNotifications();
            listenForCalls();
            loadCallHistory();
        }
        
        function cleanupApp() {
            // Detach all listeners
            if (currentUser) {
                db.ref(`contacts/${currentUser.uid}`).off();
                db.ref(`notifications/${currentUser.uid}`).off();
                db.ref(`calls`).orderByChild('receiverId').equalTo(currentUser.uid).off();
                Object.values(messageListeners).forEach(ref => ref.off());
                Object.values(unreadListeners).forEach(ref => ref.off());
                messageListeners = {};
                unreadListeners = {};
            }
            // Clear UI
            homePage.innerHTML = '';
            notificationsPage.innerHTML = '';
            callsPage.innerHTML = '';
        }
        
        function setupPresence() {
            const userStatusRef = db.ref(`/users/${currentUser.uid}/callStatus`);
            const presenceRef = db.ref('.info/connected');

            presenceRef.on('value', snap => {
                if (snap.val() === true) {
                    userStatusRef.onDisconnect().set('available').then(() => {
                        userStatusRef.set('available');
                    });
                }
            });
        }
        
        function loadContacts() {
            const contactsRef = db.ref(`contacts/${currentUser.uid}`);
            contactsRef.on('value', snapshot => {
                homePage.innerHTML = ''; // Clear existing list
                if (!snapshot.exists()) {
                    homePage.innerHTML = '<p style="text-align: center; margin-top: 20px; opacity: 0.7;">Add friends to start chatting.</p>';
                    return;
                }
                snapshot.forEach(childSnapshot => {
                    const friendUid = childSnapshot.key;
                    db.ref(`users/${friendUid}`).once('value', userSnap => {
                        if(userSnap.exists()){
                            const friendData = userSnap.val();
                            displayContact(friendUid, friendData);
                        }
                    });
                });
            });
        }
        
        function displayContact(friendUid, friendData) {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.uid = friendUid;
            
            const chatId = getChatId(currentUser.uid, friendUid);
            const unreadRef = db.ref(`unreadCounts/${currentUser.uid}/${chatId}`);
            
            item.innerHTML = `
                <div class="list-item-emoji">${friendData.emoji}</div>
                <div class="list-item-details">
                    <div class="list-item-name">${friendData.name}</div>
                    <div class="list-item-subtext">${friendData.userId}</div>
                </div>
                <div class="unread-badge" id="unread-${chatId}" style="display: none;"></div>
            `;
            
            item.addEventListener('click', () => openChat(friendUid, friendData));
            item.addEventListener('contextmenu', (e) => {
                 e.preventDefault();
                 openContactOptions(friendUid, friendData);
            });
            
            homePage.appendChild(item);
            
            // Listen for unread messages
            if(unreadListeners[chatId]) unreadListeners[chatId].off();
            unreadListeners[chatId] = unreadRef;
            
            unreadRef.on('value', snap => {
                const count = snap.val();
                const badge = document.getElementById(`unread-${chatId}`);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
        }
        
        function openContactOptions(friendUid, friendData) {
            document.getElementById('contact-options-name').textContent = friendData.name;
            
            const blockBtn = document.getElementById('contact-block-btn');
            const deleteChatBtn = document.getElementById('contact-delete-chat-btn');
            
            blockBtn.onclick = () => {
                if(confirm(`Are you sure you want to block ${friendData.name}?`)) {
                    blockUser(friendUid);
                    hideModal('contact-options-modal');
                }
            };
            
            deleteChatBtn.onclick = () => {
                if(confirm(`Are you sure you want to delete your chat history with ${friendData.name}? This cannot be undone.`)) {
                    deleteChat(friendUid);
                    hideModal('contact-options-modal');
                }
            };

            showModal('contact-options-modal');
        }

        function blockUser(blockedUid) {
            const updates = {};
            updates[`/blocked/${currentUser.uid}/${blockedUid}`] = true;
            updates[`/contacts/${currentUser.uid}/${blockedUid}`] = null;
            updates[`/contacts/${blockedUid}/${currentUser.uid}`] = null;
            db.ref().update(updates).then(() => {
                showAlert('User Blocked', 'You have blocked this user.');
            });
        }
        
        function deleteChat(friendUid) {
            const chatId = getChatId(currentUser.uid, friendUid);
            db.ref(`/messages/${chatId}`).remove().then(() => {
                showAlert('Chat Deleted', 'The chat history has been removed.');
            });
        }

        // --- Navigation ---
        bottomNavBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                bottomNavBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.content-page').forEach(page => page.classList.remove('active'));
                document.getElementById(btn.dataset.page).classList.add('active');
                
                if (btn.dataset.page === 'notifications-page') {
                    db.ref(`notifications/${currentUser.uid}`).once('value', snap => {
                        snap.forEach(childSnap => {
                            if (!childSnap.val().read) {
                                db.ref(`notifications/${currentUser.uid}/${childSnap.key}/read`).set(true);
                            }
                        });
                    });
                }
            });
        });

        // ============================ //
        // ======= FRIEND SYSTEM ====== //
        // ============================ //

        document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));

        document.getElementById('search-friend-btn').addEventListener('click', () => {
            const friendId = document.getElementById('friend-id-input').value.trim();
            const resultDiv = document.getElementById('friend-search-result');
            
            if (!friendId) return;

            db.ref('users').orderByChild('userId').equalTo(friendId).once('value', snapshot => {
                if (snapshot.exists()) {
                    const friendUid = Object.keys(snapshot.val())[0];
                    const friendData = snapshot.val()[friendUid];
                    
                    if (friendUid === currentUser.uid) {
                        resultDiv.innerHTML = '<p>You cannot add yourself.</p>';
                        return;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="list-item" style="background-color: transparent;">
                            <div class="list-item-emoji">${friendData.emoji}</div>
                            <div class="list-item-details">
                                <div class="list-item-name">${friendData.name}</div>
                            </div>
                            <button class="action-btn" id="send-request-btn" style="background-color: var(--text-color);">Send Request</button>
                        </div>
                    `;
                    document.getElementById('send-request-btn').onclick = () => sendFriendRequest(friendUid, friendData);
                } else {
                    resultDiv.innerHTML = '<p>User not found.</p>';
                }
            });
        });

        function sendFriendRequest(targetUid) {
            const requestRef = db.ref(`requests/${targetUid}/${currentUser.uid}`);
            requestRef.set({
                from: currentUser.uid,
                name: currentUser.name,
                emoji: currentUser.emoji,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            const notificationRef = db.ref(`notifications/${targetUid}`).push();
            notificationRef.set({
                type: 'friend_request',
                from: currentUser.uid,
                name: currentUser.name,
                read: false
            });
            
            document.getElementById('friend-search-result').innerHTML = '<p>Friend request sent!</p>';
        }

        function loadNotifications() {
            const notifRef = db.ref(`notifications/${currentUser.uid}`);
            notifRef.on('value', snapshot => {
                notificationsPage.innerHTML = '';
                let unreadCount = 0;
                
                if (!snapshot.exists()) {
                    notificationsPage.innerHTML = '<p style="text-align: center; margin-top: 20px; opacity: 0.7;">No new notifications.</p>';
                }
                
                snapshot.forEach(childSnapshot => {
                    const notif = childSnapshot.val();
                    const notifId = childSnapshot.key;
                    if (!notif.read) unreadCount++;
                    displayNotification(notifId, notif);
                });
                
                notificationsBadge.textContent = unreadCount;
                notificationsBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
            });
        }
        
        function displayNotification(notifId, notifData) {
            const item = document.createElement('div');
            item.className = 'list-item';
            let content = '';

            if (notifData.type === 'friend_request') {
                content = `
                    <div class="list-item-emoji">🤝</div>
                    <div class="list-item-details">
                        <div class="list-item-name">${notifData.name} sent you a friend request.</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="action-btn accept-btn" data-from="${notifData.from}" data-notif-id="${notifId}">Accept</button>
                        <button class="action-btn decline-btn" data-from="${notifData.from}" data-notif-id="${notifId}">Decline</button>
                    </div>
                `;
            } else {
                 content = `... some other notification type ...`;
            }
            item.innerHTML = content;
            notificationsPage.prepend(item);
        }
        
        notificationsPage.addEventListener('click', e => {
            const target = e.target;
            const fromUid = target.dataset.from;
            const notifId = target.dataset.notifId;
            
            if (target.classList.contains('accept-btn')) {
                acceptFriendRequest(fromUid, notifId);
            } else if (target.classList.contains('decline-btn')) {
                declineFriendRequest(fromUid, notifId);
            }
        });

        function acceptFriendRequest(fromUid, notifId) {
            const updates = {};
            updates[`/contacts/${currentUser.uid}/${fromUid}`] = true;
            updates[`/contacts/${fromUid}/${currentUser.uid}`] = true;
            updates[`/requests/${currentUser.uid}/${fromUid}`] = null;
            updates[`/notifications/${currentUser.uid}/${notifId}`] = null;

            db.ref().update(updates);
        }

        function declineFriendRequest(fromUid, notifId) {
            const updates = {};
            updates[`/requests/${currentUser.uid}/${fromUid}`] = null;
            updates[`/notifications/${currentUser.uid}/${notifId}`] = null;
            db.ref().update(updates);
        }

        // ============================ //
        // ====== MESSAGING LOGIC ===== //
        // ============================ //
        
        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }
        
        function openChat(friendUid, friendData) {
            currentChatId = getChatId(currentUser.uid, friendUid);
            currentChatPeer = friendData;
            
            document.getElementById('chat-contact-name').textContent = friendData.name;
            messagesContainer.innerHTML = '';
            
            chatView.classList.add('active');
            
            // Clear unread count
            db.ref(`unreadCounts/${currentUser.uid}/${currentChatId}`).set(0);

            loadMessages();
        }

        function loadMessages() {
            const messagesRef = db.ref(`messages/${currentChatId}`).limitToLast(50);
            
            if (messageListeners[currentChatId]) messageListeners[currentChatId].off();
            messageListeners[currentChatId] = messagesRef;
            
            messagesRef.on('child_added', snapshot => {
                const message = snapshot.val();
                displayMessage(message);
                if(message.senderId !== currentUser.uid && chatView.classList.contains('active')){
                    messageToneAudio.play();
                }
            });
        }
        
        function displayMessage(message) {
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.classList.add(message.senderId === currentUser.uid ? 'sent' : 'received');
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'});
            
            bubble.innerHTML = `
                ${message.text}
                <span class="message-timestamp">${time}</span>
            `;
            messagesContainer.prepend(bubble);
        }
        
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text && currentChatId) {
                const messageData = {
                    text,
                    senderId: currentUser.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                db.ref(`messages/${currentChatId}`).push(messageData);
                
                // Increment unread count for the other user
                const friendUid = currentChatId.replace(currentUser.uid, '').replace('_', '');
                const unreadRef = db.ref(`unreadCounts/${friendUid}/${currentChatId}`);
                unreadRef.transaction(currentCount => (currentCount || 0) + 1);

                input.value = '';
            }
        }
        
        document.getElementById('chat-back-btn').addEventListener('click', () => {
            if(messageListeners[currentChatId]) messageListeners[currentChatId].off();
            currentChatId = null;
            currentChatPeer = null;
            chatView.classList.remove('active');
        });
        
        // ============================ //
        // ===== WEBRTC CALL LOGIC ==== //
        // ============================ //

        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ],
        };

        document.getElementById('voice-call-btn').addEventListener('click', () => initiateCall(false));
        document.getElementById('video-call-btn').addEventListener('click', () => initiateCall(true));

        async function initiateCall(isVideo) {
            // Check if friend is available
            const friendStatusRef = db.ref(`users/${currentChatPeer.userId.replace('hai-', '')}/callStatus`);
            const friendStatusSnap = await db.ref(`users/${currentChatId.replace(currentUser.uid, '').replace('_', '')}`).child('callStatus').once('value');
            if(friendStatusSnap.val() === 'busy'){
                showAlert('User Busy', `${currentChatPeer.name} is currently on another call.`);
                return;
            }

            const callId = db.ref('calls').push().key;
            currentCallData = {
                callId,
                callerId: currentUser.uid,
                callerInfo: { name: currentUser.name, emoji: currentUser.emoji },
                receiverId: currentChatId.replace(currentUser.uid, '').replace('_', ''),
                status: 'ringing',
                isVideo,
            };

            // Setup local stream
            localStream = await navigator.mediaDevices.getUserMedia({
                video: isVideo,
                audio: true,
            });
            
            // Show local video if applicable
            if (isVideo) {
                showView('call-view');
                document.getElementById('local-video').srcObject = localStream;
            } else {
                showView('audio-call-view');
                document.getElementById('audio-callee-emoji').textContent = currentChatPeer.emoji;
                document.getElementById('audio-callee-name').textContent = currentChatPeer.name;
                document.getElementById('audio-call-status').textContent = 'Calling...';
            }
            
            // Create Peer Connection
            peerConnection = new RTCPeerConnection(servers);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = event => {
                remoteStream = event.streams[0];
                if (currentCallData.isVideo) {
                    document.getElementById('remote-video').srcObject = remoteStream;
                }
            };
            
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    db.ref(`iceCandidates/${callId}/${currentUser.uid}`).push(event.candidate.toJSON());
                }
            };
            
            // Create Offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            currentCallData.offer = {
                type: offer.type,
                sdp: offer.sdp,
            };

            await db.ref(`calls/${callId}`).set(currentCallData);
            await db.ref(`users/${currentUser.uid}/callStatus`).set('busy');
            
            listenForCallUpdates(callId);
        }
        
        function listenForCalls() {
            const incomingCallsRef = db.ref('calls').orderByChild('receiverId').equalTo(currentUser.uid);
            
            if(callListeners['incoming']) callListeners['incoming'].off();
            callListeners['incoming'] = incomingCallsRef;

            incomingCallsRef.on('child_added', async (snapshot) => {
                const callData = snapshot.val();
                if (callData.status === 'ringing' && currentUser.callStatus !== 'busy') {
                    currentCallData = { callId: snapshot.key, ...callData };
                    
                    document.getElementById('incoming-call-emoji').textContent = callData.callerInfo.emoji;
                    document.getElementById('incoming-call-name').textContent = `${callData.callerInfo.name} is calling...`;
                    document.getElementById('incoming-call-type').textContent = callData.isVideo ? 'Video Call' : 'Voice Call';
                    
                    showModal('incoming-call-modal');
                    incomingCallAudio.play();
                }
            });
        }
        
        document.getElementById('accept-call-btn').addEventListener('click', async () => {
            incomingCallAudio.pause();
            incomingCallAudio.currentTime = 0;
            hideModal('incoming-call-modal');
            await db.ref(`users/${currentUser.uid}/callStatus`).set('busy');
            
            localStream = await navigator.mediaDevices.getUserMedia({
                video: currentCallData.isVideo,
                audio: true,
            });
            
            if (currentCallData.isVideo) {
                showView('call-view');
                document.getElementById('local-video').srcObject = localStream;
            } else {
                 showView('audio-call-view');
                 db.ref(`users/${currentCallData.callerId}`).once('value', snap => {
                    const peer = snap.val();
                    document.getElementById('audio-callee-emoji').textContent = peer.emoji;
                    document.getElementById('audio-callee-name').textContent = peer.name;
                    document.getElementById('audio-call-status').textContent = 'Connecting...';
                 });
            }
            
            peerConnection = new RTCPeerConnection(servers);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = event => {
                remoteStream = event.streams[0];
                if (currentCallData.isVideo) {
                    document.getElementById('remote-video').srcObject = remoteStream;
                }
            };
            
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    db.ref(`iceCandidates/${currentCallData.callId}/${currentUser.uid}`).push(event.candidate.toJSON());
                }
            };
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(currentCallData.offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            const callRef = db.ref(`calls/${currentCallData.callId}`);
            await callRef.update({
                status: 'answered',
                answer: { type: answer.type, sdp: answer.sdp }
            });
            
            listenForCallUpdates(currentCallData.callId);
        });
        
        document.getElementById('reject-call-btn').addEventListener('click', async () => {
             incomingCallAudio.pause();
             incomingCallAudio.currentTime = 0;
             hideModal('incoming-call-modal');
             const callRef = db.ref(`calls/${currentCallData.callId}`);
             await callRef.update({ status: 'rejected' });
             logCall('rejected');
             currentCallData = null;
        });
        
        function listenForCallUpdates(callId) {
            const callRef = db.ref(`calls/${callId}`);
            
            if(callListeners[callId]) callListeners[callId].off();
            callListeners[callId] = callRef;

            callRef.on('value', async (snapshot) => {
                const callData = snapshot.val();
                if (!callData) return;
                
                // If caller, listen for answer
                if (callData.answer && !peerConnection.currentRemoteDescription) {
                    const answerDescription = new RTCSessionDescription(callData.answer);
                    await peerConnection.setRemoteDescription(answerDescription);
                }

                if (callData.status === 'answered' && document.getElementById('audio-call-status')) {
                    document.getElementById('audio-call-status').textContent = 'Connected';
                }
                
                if (callData.status === 'rejected' || callData.status === 'ended') {
                    logCall(callData.status);
                    cleanupCall();
                }
            });
            
            // Listen for ICE candidates
            const peerId = currentCallData.callerId === currentUser.uid ? currentCallData.receiverId : currentCallData.callerId;
            const iceCandidateRef = db.ref(`iceCandidates/${callId}/${peerId}`);
            
            if(callListeners[`ice_${callId}`]) callListeners[`ice_${callId}`].off();
            callListeners[`ice_${callId}`] = iceCandidateRef;
            
            iceCandidateRef.on('child_added', snapshot => {
                if (snapshot.exists()) {
                    const candidate = new RTCIceCandidate(snapshot.val());
                    peerConnection.addIceCandidate(candidate);
                }
            });
        }
        
        function endCall() {
            if (currentCallData && currentCallData.callId) {
                db.ref(`calls/${currentCallData.callId}`).update({ status: 'ended' });
            }
        }
        document.getElementById('end-video-call-btn').addEventListener('click', endCall);
        document.getElementById('end-audio-call-btn').addEventListener('click', endCall);
        
        function cleanupCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            if (currentCallData && currentCallData.callId) {
                db.ref(`calls/${currentCallData.callId}`).off();
                db.ref(`iceCandidates/${currentCallData.callId}`).off();
                // A bit aggressive, but cleans up after call
                db.ref(`calls/${currentCallData.callId}`).remove();
                db.ref(`iceCandidates/${currentCallData.callId}`).remove();
            }

            // Clean up UI
            showView('main-app-view');
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-video').srcObject = null;
            
            db.ref(`users/${currentUser.uid}/callStatus`).set('available');
            currentCallData = null;
        }
        
        // ============================ //
        // ======== UI & HELPERS ====== //
        // ============================ //
        
        function showView(viewId) {
            // This function handles switching between the main, mutually exclusive views.
            const viewsToToggle = ['auth-view', 'main-app-view', 'call-view', 'audio-call-view'];
            viewsToToggle.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('active');
            });
            
            const view = document.getElementById(viewId);
            if (view) {
                view.classList.add('active');
            }
        }
        
        function showModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function hideModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        
        function showAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            showModal('alert-modal');
        }

        document.querySelectorAll('[data-close]').forEach(el => {
            el.addEventListener('click', () => el.closest('.modal-overlay').classList.remove('active'));
        });
        
        // --- Menu Logic ---
        document.getElementById('menu-btn').addEventListener('click', () => showModal('menu-modal'));
        document.getElementById('menu-logout-btn').addEventListener('click', () => {
            auth.signOut();
            hideModal('menu-modal');
        });
        document.getElementById('menu-theme-btn').addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
        });
        document.getElementById('menu-profile-btn').addEventListener('click', () => {
             document.getElementById('profile-id-display').textContent = `ID: ${currentUser.userId}`;
             document.getElementById('profile-name-input').value = currentUser.name;
             document.getElementById('profile-emoji-input').value = currentUser.emoji;
             hideModal('menu-modal');
             showModal('profile-modal');
        });
        document.getElementById('save-profile-btn').addEventListener('click', () => {
            const newName = document.getElementById('profile-name-input').value.trim();
            const newEmoji = document.getElementById('profile-emoji-input').value.trim();
            if(newName && newEmoji) {
                db.ref(`users/${currentUser.uid}`).update({ name: newName, emoji: newEmoji });
                currentUser.name = newName;
                currentUser.emoji = newEmoji;
                hideModal('profile-modal');
            }
        });
        
        // --- Blocked Users ---
        document.getElementById('menu-blocked-btn').addEventListener('click', async () => {
            hideModal('menu-modal');
            const listEl = document.getElementById('blocked-users-list');
            listEl.innerHTML = 'Loading...';
            showModal('blocked-users-modal');
            const blockedSnap = await db.ref(`blocked/${currentUser.uid}`).once('value');
            if (blockedSnap.exists()) {
                listEl.innerHTML = '';
                const blockedUids = Object.keys(blockedSnap.val());
                blockedUids.forEach(async uid => {
                    const userSnap = await db.ref(`users/${uid}`).once('value');
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        const item = document.createElement('div');
                        item.className = 'list-item';
                        item.innerHTML = `
                            <div class="list-item-emoji">${userData.emoji}</div>
                            <div class="list-item-details"><div class="list-item-name">${userData.name}</div></div>
                            <button class="action-btn" data-unblock-uid="${uid}" style="background-color: var(--accent-color);">Unblock</button>
                        `;
                        listEl.appendChild(item);
                    }
                });
            } else {
                listEl.innerHTML = '<p>No blocked users.</p>';
            }
        });
        
        document.getElementById('blocked-users-list').addEventListener('click', e => {
            if(e.target.dataset.unblockUid) {
                const uidToUnblock = e.target.dataset.unblockUid;
                db.ref(`blocked/${currentUser.uid}/${uidToUnblock}`).remove().then(() => {
                    e.target.closest('.list-item').remove();
                });
            }
        });

        // --- Call History ---
        function logCall(status) {
            if (!currentCallData) return;
            const peerId = currentCallData.callerId === currentUser.uid ? currentCallData.receiverId : currentCallData.callerId;
            db.ref(`users/${peerId}`).once('value', snap => {
                const peerData = snap.val();
                const logEntry = {
                    callType: currentCallData.isVideo ? 'video' : 'voice',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    direction: currentCallData.callerId === currentUser.uid ? 'outgoing' : 'incoming',
                    peerId: peerId,
                    peerName: peerData ? peerData.name : 'Unknown',
                    status: status, // ended, rejected, missed
                };
                db.ref(`callHistory/${currentUser.uid}`).push(logEntry);
            });
        }
        
        function loadCallHistory() {
            const historyRef = db.ref(`callHistory/${currentUser.uid}`).orderByChild('timestamp').limitToLast(30);
            historyRef.on('value', snapshot => {
                callsPage.innerHTML = '';
                 if (!snapshot.exists()) {
                    callsPage.innerHTML = '<p style="text-align: center; margin-top: 20px; opacity: 0.7;">No recent calls.</p>';
                    return;
                }
                const logs = [];
                snapshot.forEach(child => logs.push(child.val()));
                logs.reverse().forEach(log => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    const icon = log.callType === 'video' ? '📹' : '📞';
                    const directionIcon = log.direction === 'outgoing' ? '↗️' : '↙️';
                    const date = new Date(log.timestamp).toLocaleString();
                    item.innerHTML = `
                        <div class="list-item-emoji">${icon}</div>
                        <div class="list-item-details">
                            <div class="list-item-name">${log.peerName} ${directionIcon}</div>
                            <div class="list-item-subtext">${log.status} - ${date}</div>
                        </div>
                    `;
                    callsPage.appendChild(item);
                });
            });
        }
        
        // --- Draggable local video ---
        const localVideo = document.getElementById('local-video');
        let isDragging = false;
        let dragOffsetX, dragOffsetY;

        localVideo.addEventListener('mousedown', e => {
            isDragging = true;
            localVideo.style.cursor = 'grabbing';
            dragOffsetX = e.clientX - localVideo.offsetLeft;
            dragOffsetY = e.clientY - localVideo.offsetTop;
        });
        document.addEventListener('mousemove', e => {
            if (isDragging) {
                let x = e.clientX - dragOffsetX;
                let y = e.clientY - dragOffsetY;
                
                // Constrain to parent
                const parentRect = localVideo.parentElement.getBoundingClientRect();
                x = Math.max(0, Math.min(x, parentRect.width - localVideo.offsetWidth));
                y = Math.max(0, Math.min(y, parentRect.height - localVideo.offsetHeight));

                localVideo.style.left = `${x}px`;
                localVideo.style.top = `${y}px`;
                localVideo.style.right = 'auto';
                localVideo.style.bottom = 'auto';
            }
        });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            localVideo.style.cursor = 'grab';
        });
        
        // --- Speakerphone toggle ---
        document.getElementById('speaker-btn').addEventListener('click', () => {
            isSpeakerOn = !isSpeakerOn;
            document.getElementById('speaker-btn').classList.toggle('active', isSpeakerOn);
            // This is a simplification. Real speakerphone control requires more complex audio routing.
            // For now, it just toggles the button's appearance.
            // In a real app you'd manage audio output devices.
            console.log(`Speakerphone is now ${isSpeakerOn ? 'ON' : 'OFF'}`);
        });

    })();
    </script>

</body>
</html>