<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HaiCalling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f0f2f5;
            --text-color: #333;
            --error-color: #d93025;
        }
        html, body {
            height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; background-color: var(--secondary-color);
        }
        
        /* --- Page Management --- */
        .page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #ffffff;
            transition: opacity 0.4s ease, visibility 0.4s;
            /* BUG FIX: Start all pages hidden except the loading screen */
            visibility: hidden; opacity: 0; 
        }
        .page.visible { visibility: visible; opacity: 1; }

        /* --- Individual Pages --- */
        #loading-page .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #auth-page .container { width: 90%; max-width: 400px; text-align: center; }
        #auth-page h1 { color: var(--primary-color); }
        #auth-page input { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #auth-page button { width: 100%; padding: 12px; border-radius: 8px; border: none; background-color: var(--primary-color); color: white; font-size: 18px; cursor: pointer; }
        #auth-page .links { margin-top: 20px; }
        #auth-page .links a { color: var(--primary-color); text-decoration: none; cursor: pointer; }
        .form-container { display: none; }
        .form-container.active { display: block; }
        .error-message { color: var(--error-color); margin-bottom: 15px; min-height: 1.2em; }

        #profile-setup-page .container, #welcome-page { width: 90%; max-width: 400px; text-align: center; }
        #profile-setup-page h2 { color: var(--text-color); }
        #profile-setup-page input { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #profile-setup-page button { width: 100%; padding: 12px; border-radius: 8px; border: none; background-color: #4CAF50; color: white; font-size: 18px; cursor: pointer; }
        #welcome-page h1 { font-size: 48px; color: var(--primary-color); }
        
        #home-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: opacity 0.5s ease;
            visibility: hidden; opacity: 0; pointer-events: none;
        }
        #home-screen.visible { visibility: visible; opacity: 1; pointer-events: auto; }

        .home-header { height: 60px; background-color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .app-name { font-size: 22px; font-weight: bold; color: var(--primary-color); }
        .menu-btn, .add-friend-btn { background: none; border: none; font-size: 22px; color: var(--primary-color); cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        
        .home-content { flex-grow: 1; background-color: var(--secondary-color); display: flex; align-items: center; justify-content: center; text-align: center; color: var(--text-color); }
        .home-footer { height: 65px; background-color: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; flex-shrink: 0; }
        .footer-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #999; font-size: 12px; cursor: pointer; }
        .footer-btn i { font-size: 24px; margin-bottom: 4px; }
        .footer-btn.active { color: var(--primary-color); }
    </style>
</head>
<body>

    <!-- Pages remain the same -->
    <div class="page visible" id="loading-page"><div class="spinner"></div></div>
    <div class="page" id="auth-page"><div class="container"><h1>HaiCalling</h1><div id="login-container" class="form-container active"><form id="login-form"><p class="error-message" id="login-error"></p><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Password" required><button type="submit">Login</button></form><div class="links"><a id="show-register-link">Don't have an account? Register</a></div></div><div id="register-container" class="form-container"><form id="register-form"><p class="error-message" id="register-error"></p><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="Password (min. 6 chars)" required><button type="submit">Register</button></form><div class="links"><a id="show-login-link">Already have an account? Login</a></div></div></div></div>
    <div class="page" id="profile-setup-page"><div class="container"><h2>Set Up Your Profile</h2><form id="profile-form"><p class="error-message" id="profile-error"></p><input type="text" id="profile-name" placeholder="Your Name" required><input type="text" id="profile-dob" placeholder="Date of Birth" onfocus="(this.type='date')" onblur="(this.type='text')" required><input type="url" id="profile-image" placeholder="Link to your Profile Image/Emoji" required><button type="submit">Save and Continue</button></form></div></div>
    <div class="page" id="welcome-page"><h1 id="welcome-user-name">Welcome!</h1></div>
    <div id="home-screen">
        <header class="home-header"><button class="menu-btn"><i class="fas fa-bars"></i></button><span class="app-name">HaiCalling</span><button class="add-friend-btn"><i class="fas fa-user-plus"></i></button></header>
        <main class="home-content"><div><h2>Home Content</h2></div></main>
        <footer class="home-footer"><button class="footer-btn"><i class="fas fa-bell"></i><span>Notifications</span></button><button class="footer-btn active"><i class="fas fa-home"></i><span>Home</span></button><button class="footer-btn"><i class="fas fa-phone"></i><span>Calling</span></button></footer>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // BUG FIX: Wrap all code in DOMContentLoaded to ensure HTML is ready before script runs
        document.addEventListener('DOMContentLoaded', () => {

            // --- YOUR SECURE FIREBASE CONFIG ---
            const firebaseConfig = {
                apiKey: "AIzaSyAD2S8b5dxYV1fFYc-RMJMwV1IQ3yCRvd0", // IMPORTANT: Use your new key
                authDomain: "haicalling.firebaseapp.com",
                databaseURL: "https://haicalling-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "haicalling",
                storageBucket: "haicalling.appspot.com",
                messagingSenderId: "379823659600",
                appId: "1:379823659600:web:d86fb74951ce52206b4f55"
            };
            
            // --- INITIALIZE FIREBASE and SERVICES ---
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                alert("Could not connect to the service. Please check your configuration and internet connection.");
                return; // Stop the script if Firebase fails to initialize
            }
            
            const auth = firebase.auth();
            const db = firebase.firestore();

            // --- PAGE & ELEMENT SELECTORS ---
            const pages = document.querySelectorAll('.page');
            const homeScreen = document.getElementById('home-screen');
            const loginContainer = document.getElementById('login-container');
            const registerContainer = document.getElementById('register-container');
            
            // --- UI HELPER FUNCTION ---
            function showPage(pageId) {
                // Hide all pages and the home screen first
                pages.forEach(page => page.classList.remove('visible'));
                homeScreen.classList.remove('visible');
                
                // Then show the correct one
                const pageToShow = document.getElementById(pageId);
                if (pageToShow) {
                    pageToShow.classList.add('visible');
                } else if (pageId === 'home-screen') {
                    homeScreen.classList.add('visible');
                }
                console.log(`Navigating to page: ${pageId}`); // Debugging log
            }

            // --- AUTH STATE LISTENER (CORE LOGIC) ---
            auth.onAuthStateChanged(async (user) => {
                console.log("Auth state changed. User:", user ? user.uid : 'null');
                if (user) {
                    try {
                        const userDocRef = db.collection('users').doc(user.uid);
                        const userDoc = await userDocRef.get();
                        
                        if (userDoc.exists) {
                            console.log("User profile found. Navigating to home.");
                            showPage('home-screen');
                        } else {
                            console.log("User profile NOT found. Navigating to setup.");
                            showPage('profile-setup-page');
                        }
                    } catch (error) {
                        console.error("Error checking user document in Firestore:", error);
                        alert("There was a problem checking your profile. Please check your internet connection and Firestore rules.");
                    }
                } else {
                    console.log("No user signed in. Navigating to auth page.");
                    showPage('auth-page');
                }
            });

            // --- FORM SUBMISSION HANDLERS ---
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorElement = document.getElementById('login-error');
                errorElement.textContent = ''; // Clear previous errors
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Login failed:", error);
                        errorElement.textContent = error.message;
                    });
            });

            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorElement = document.getElementById('register-error');
                errorElement.textContent = '';
                auth.createUserWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Registration failed:", error);
                        errorElement.textContent = error.message;
                    });
            });

            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const errorElement = document.getElementById('profile-error');
                errorElement.textContent = '';
                if (user) {
                    const profileName = document.getElementById('profile-name').value;
                    try {
                        await db.collection('users').doc(user.uid).set({
                            name: profileName,
                            dob: document.getElementById('profile-dob').value,
                            imageUrl: document.getElementById('profile-image').value,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        document.getElementById('welcome-user-name').textContent = `Welcome, ${profileName}!`;
                        showPage('welcome-page');
                        setTimeout(() => showPage('home-screen'), 2000);
                    } catch (error) {
                        console.error("Failed to save profile:", error);
                        errorElement.textContent = "Could not save profile. Please try again.";
                    }
                }
            });
            
            // --- AUTH FORM TOGGLING ---
            document.getElementById('show-register-link').addEventListener('click', () => {
                loginContainer.classList.remove('active');
                registerContainer.classList.add('active');
            });
            document.getElementById('show-login-link').addEventListener('click', () => {
                registerContainer.classList.remove('active');
                loginContainer.classList.add('active');
            });
        });
    </script>
</body>
</html>
