<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HaiCalling</title>
    <style>
        :root {
            --primary-text: #000000; --accent-color: #6a11cb; --accent-gradient: linear-gradient(135deg, #2575fc, #6a11cb);
            --error-color: #e53935; --success-color: #43a047; --notification-badge: #e53935;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); --glass-bg: rgba(255, 255, 255, 0.35);
            --glass-border: rgba(255, 255, 255, 0.5); --input-bg: rgba(255, 255, 255, 0.5); --placeholder-color: #555;
        }
        .dark-mode {
            --primary-text: #ffffff; --accent-color: #8e2de2; --accent-gradient: linear-gradient(135deg, #4a00e0, #8e2de2);
            --bg-gradient: linear-gradient(135deg, #141e30 0%, #243b55 100%); --glass-bg: rgba(30, 30, 30, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1); --input-bg: rgba(0, 0, 0, 0.2); --placeholder-color: #ccc;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; color: var(--primary-text); background: var(--bg-gradient); background-attachment: fixed; overscroll-behavior-y: contain; }
        ::placeholder { color: var(--placeholder-color); opacity: 1; }
        .glass-effect { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .app-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; }
        .screen { display: none; flex-direction: column; width: 100%; height: 100%; }
        .screen.active { display: flex; }
        #auth-screen { justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .auth-form { width: 100%; max-width: 340px; padding: 30px 25px; border-radius: 20px; display: flex; flex-direction: column; gap: 20px; }
        .auth-form h1 { text-align: center; color: var(--primary-text); font-weight: 600; margin: 0 0 10px 0; }
        #login-view, #register-view { display: flex; flex-direction: column; gap: 15px; }
        input[type="email"], input[type="password"], input[type="text"] { padding: 14px; border: 1px solid var(--glass-border); border-radius: 12px; font-size: 16px; background-color: var(--input-bg); color: var(--primary-text); text-align: center; }
        input:focus { outline: 2px solid var(--accent-color); }
        button { padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; background: var(--accent-gradient); color: white; transition: transform 0.2s ease; }
        button:active { transform: scale(0.97); }
        button:disabled { background: grey; cursor: not-allowed; }
        .link-button { background: none; color: var(--accent-color); font-size: 14px; font-weight: 500; width: auto; align-self: center; padding: 5px; }
        .app-header, .app-footer { display: flex; align-items: center; justify-content: space-between; padding: 0 15px; height: 65px; flex-shrink: 0; border: none; }
        .app-header { border-radius: 0 0 20px 20px; margin: 0 10px; margin-top: -1px; }
        .app-footer { border-radius: 20px 20px 0 0; margin: 0 10px; margin-bottom: -1px; justify-content: space-around; }
        .app-header h1 { font-size: 22px; font-weight: bold; margin: 0; }
        .icon { font-size: 24px; padding: 8px; cursor: pointer; position: relative; }
        .notification-badge { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: var(--notification-badge); border-radius: 50%; display: none; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        #chat-list { list-style: none; padding: 0; margin: 0; }
        #chat-list li { display: flex; align-items: center; padding: 15px; margin: 5px 20px; cursor: pointer; border-radius: 15px; }
        #chat-list li:hover { background: var(--glass-bg); }
        #chat-messages { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px 16px; border-radius: 20px; max-width: 75%; word-wrap: break-word; }
        .message.sent { background: var(--accent-gradient); color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
        .message.received { align-self: flex-start; border-bottom-left-radius: 6px; }
        #chat-input-area { display: flex; padding: 10px 15px; background: var(--glass-bg); backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border); }
        #chat-input-area input { flex-grow: 1; margin-right: 10px; border-radius: 20px; }
        #chat-input-area button { border-radius: 50%; width: 48px; height: 48px; padding: 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; text-align: center; }
        #menu-screen ul { list-style: none; padding: 10px 0; margin: 0; }
        #menu-screen ul li { margin: 5px 20px; padding: 18px 20px; border-radius: 15px; cursor: pointer; }
        #menu-screen ul li:hover { background: var(--glass-bg); }
        #unique-code-display { padding: 10px; border-radius: 10px; font-family: monospace; text-align: center; margin-top: 5px; }
        #video-call-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; display: none; z-index: 2000; }
        #local-video, #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #remote-video { position: absolute; top: 0; left: 0; }
        #local-video { width: 120px; height: 160px; position: absolute; bottom: 90px; right: 20px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 15px; }
        #call-controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        #call-controls button { width: 60px; height: 60px; border-radius: 50%; font-size: 24px; }
        #end-call-btn { background: var(--error-color); }
        .call-button { width: 70px !important; height: 70px !important; border-radius: 50% !important; font-size: 30px !important; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Authentication Screen -->
        <div id="auth-screen" class="screen active">
            <div class="auth-form glass-effect">
                <h1>HaiCalling</h1>
                <div id="login-view">
                    <input type="email" id="login-email" placeholder="Email">
                    <input type="password" id="login-password" placeholder="Password">
                    <button id="login-btn">Login</button>
                    <button id="show-register-btn" class="link-button">No tienes cuenta? Reg√≠strate</button>
                    <button id="forgot-password-btn" class="link-button">Olvidaste tu contrase√±a?</button>
                </div>
                <div id="register-view" style="display: none;">
                    <input type="email" id="register-email" placeholder="Email">
                    <input type="password" id="register-password" placeholder="Password">
                    <button id="register-btn">Reg√≠strate</button>
                    <button id="show-login-btn" class="link-button">Ya tienes cuenta? Inicia sesi√≥n</button>
                </div>
            </div>
        </div>

        <!-- Home Page -->
        <div id="home-page" class="screen">
            <header class="app-header glass-effect">
                <div id="menu-btn" class="icon">‚ò∞</div>
                <h1>HaiCalling</h1>
                <div id="add-friend-btn" class="icon">+</div>
            </header>
            <main class="main-content">
                <p id="no-friends-message" style="text-align:center; padding: 20px; display: none;">No tienes amigos todav√≠a. Haz clic en '+' para a√±adir uno!</p>
                <ul id="chat-list"></ul>
            </main>
            <footer class="app-footer glass-effect">
                <div id="notifications-btn" class="icon">üîî<div class="notification-badge"></div></div>
                <div id="home-btn" class="icon">üè†</div>
                <div class="icon">üìû</div>
            </footer>
        </div>
        
        <!-- Chat Screen -->
        <div id="chat-screen" class="screen">
            <header class="app-header glass-effect">
                <div id="back-to-home-btn" class="icon">‚Üê</div>
                <h1 id="chat-friend-username"></h1>
                <div>
                    <span id="voice-call-btn" class="icon">üìû</span>
                    <span id="video-call-btn" class="icon">üìπ</span>
                </div>
            </header>
            <main id="chat-messages" class="main-content"></main>
            <form id="chat-input-area">
                <input type="text" id="message-input" placeholder="Escribe un mensaje..." autocomplete="off">
                <button id="send-message-btn" type="submit">‚û§</button>
            </form>
        </div>

        <!-- Menu Screen -->
        <div id="menu-screen" class="screen">
             <header class="app-header glass-effect">
                <div id="back-from-menu-btn" class="icon">‚Üê</div><h1>Menu</h1><div></div>
            </header>
            <main class="main-content">
                <ul>
                    <li id="edit-profile-menu-btn" class="glass-effect">Editar Perfil</li>
                    <li class="glass-effect">Tu C√≥digo √önico:<div id="unique-code-display" class="glass-effect"></div></li>
                    <li id="block-list-menu-btn" class="glass-effect">Lista de Bloqueados</li>
                    <li id="toggle-theme-btn" class="glass-effect">Cambiar Tema</li>
                    <li id="logout-btn" class="glass-effect" style="color: var(--error-color);">Cerrar Sesi√≥n</li>
                </ul>
            </main>
        </div>

    </div>
    
    <!-- Modals -->
    <div id="profile-setup-modal" class="modal"><div class="modal-content glass-effect"><h2>Configuraci√≥n de Perfil</h2><p>Bienvenido! Por favor, configura tu perfil.</p><input type="text" id="profile-username" placeholder="Elige un nombre de usuario"><button id="save-profile-btn">Guardar Perfil</button></div></div>
    <div id="success-popup" class="modal"><div class="modal-content glass-effect"><h2>√âxito!</h2><p id="success-message"></p><button class="close-modal-btn">Continuar</button></div></div>
    <div id="add-friend-modal" class="modal"><div class="modal-content glass-effect"><span class="close-modal-btn" style="position:absolute; top:10px; right: 20px; cursor:pointer;">X</span><h2>A√±adir Amigo</h2><input type="text" id="search-friend-input" placeholder="Nombre o c√≥digo √∫nico"><button id="search-friend-btn">Buscar</button><div id="friend-search-results" style="margin-top: 15px;"></div></div></div>
    <div id="notifications-modal" class="modal"><div class="modal-content glass-effect"><span class="close-modal-btn" style="position:absolute; top:10px; right: 20px; cursor:pointer;">X</span><h2>Notificaciones</h2><div id="notifications-list"></div></div></div>
    <div id="incoming-call-modal" class="modal"><div class="modal-content glass-effect"><h2 id="incoming-call-text">Llamada Entrante...</h2><div style="display: flex; justify-content: space-around; margin-top: 20px;"><button id="answer-call-btn" class="call-button" style="background: var(--success-color);">‚úì</button><button id="reject-call-btn" class="call-button" style="background: var(--error-color);">X</button></div></div></div>

    <!-- Video Call UI -->
    <div id="video-call-container"><video id="remote-video" autoplay playsinline></video><video id="local-video" autoplay playsinline muted></video><div id="call-controls"><button id="end-call-btn">‚úñ</button></div></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAD2S8b5dxYV1fFYc-RMJMwV1IQ3yCRvd0",
            authDomain: "haicalling.firebaseapp.com",
            databaseURL: "https://haicalling-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haicalling",
            storageBucket: "haicalling.appspot.com",
            messagingSenderId: "379823659600",
            appId: "1:379823659600:web:d86fb74951ce52206b4f55"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const fieldValue = firebase.firestore.FieldValue;

        // --- GLOBAL APP STATE & LISTENERS ---
        let currentUser = null;
        let currentChatInfo = { uid: null, username: null, chatId: null };
        let localStream;
        let remoteStream;
        let peerConnection;
        let incomingCallListener = null;
        let friendRequestListener = null;
        let friendsListener = null;

        // --- WebRTC Configuration ---
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }], iceCandidatePoolSize: 10 };

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const modals = document.querySelectorAll('.modal');
        const notificationBadge = document.querySelector('.notification-badge');

        // --- Utility Functions ---
        const showScreen = (screenId) => { screens.forEach(s => s.classList.remove('active')); document.getElementById(screenId)?.classList.add('active'); };
        const showModal = (modalId, message = '') => { 
            if(message) document.getElementById('success-message').innerText = message;
            document.getElementById(modalId)?.classList.add('active'); 
        };
        const hideModals = () => modals.forEach(m => m.classList.remove('active'));

        // --- App Initialization ---
        auth.onAuthStateChanged(async (user) => {
            if (incomingCallListener) incomingCallListener();
            if (friendRequestListener) friendRequestListener();
            if (friendsListener) friendsListener();
            hideModals();

            if (user) {
                currentUser = user;
                const userProfile = await db.collection('users').doc(user.uid).get();
                if (!userProfile.exists || !userProfile.data().username) {
                    showModal('profile-setup-modal');
                } else {
                    await setupAppForUser(user.uid);
                    showScreen('home-page');
                }
            } else {
                currentUser = null;
                showScreen('auth-screen');
            }
        });

        async function setupAppForUser(uid) {
            const userDoc = await db.collection('users').doc(uid).get();
            document.getElementById('unique-code-display').innerText = userDoc.data().uniqueCode;
            listenForFriendRequests(uid);
            listenForFriends(uid);
            listenForIncomingCalls(uid);
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            if (e.target.matches('.close-modal-btn') || e.target.matches('.modal')) {
                hideModals();
            }
        });
        document.querySelectorAll('.modal-content').forEach(el => el.addEventListener('click', e => e.stopPropagation()));
        
        // Auth buttons
        document.getElementById('login-btn').addEventListener('click', () => {
            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => alert(err.message));
        });
        document.getElementById('register-btn').addEventListener('click', () => {
            auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value).catch(err => alert(err.message));
        });
        document.getElementById('forgot-password-btn').addEventListener('click', () => {
            const email = prompt("Ingresa tu email para resetear tu contrase√±a:");
            if(email) auth.sendPasswordResetEmail(email).then(() => alert("Email de reseteo enviado!")).catch(err => alert(err.message));
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        document.getElementById('show-register-btn').addEventListener('click', () => { document.getElementById('login-view').style.display = 'none'; document.getElementById('register-view').style.display = 'flex'; });
        document.getElementById('show-login-btn').addEventListener('click', () => { document.getElementById('login-view').style.display = 'flex'; document.getElementById('register-view').style.display = 'none'; });

        // Navigation
        document.getElementById('menu-btn').addEventListener('click', () => showScreen('menu-screen'));
        document.getElementById('back-from-menu-btn').addEventListener('click', () => showScreen('home-page'));
        document.getElementById('back-to-home-btn').addEventListener('click', () => { showScreen('home-page'); currentChatInfo = {}; });
        document.getElementById('home-btn').addEventListener('click', () => showScreen('home-page'));
        document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));
        document.getElementById('notifications-btn').addEventListener('click', () => showModal('notifications-modal'));
        document.getElementById('toggle-theme-btn').addEventListener('click', () => document.body.classList.toggle('dark-mode'));

        // Profile
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const username = document.getElementById('profile-username').value;
            if (username.length < 3) { alert("El nombre de usuario debe tener al menos 3 caracteres."); return; }
            const uniqueCode = `haicalling_${Math.random().toString(36).substr(2, 9)}`;
            await db.collection('users').doc(currentUser.uid).set({ username, email: currentUser.email, uniqueCode, uid: currentUser.uid });
            hideModals();
            showModal('success-popup', 'Tu perfil se ha configurado con √©xito.');
            await setupAppForUser(currentUser.uid);
            showScreen('home-page');
        });

        // Friend System
        document.getElementById('search-friend-btn').addEventListener('click', async () => {
            const queryVal = document.getElementById('search-friend-input').value.trim();
            const resultsDiv = document.getElementById('friend-search-results');
            resultsDiv.innerHTML = 'Buscando...';

            const nameQuery = db.collection('users').where('username', '==', queryVal).get();
            const codeQuery = db.collection('users').where('uniqueCode', '==', queryVal).get();
            const [nameSnapshot, codeSnapshot] = await Promise.all([nameQuery, codeQuery]);
            const users = new Map();
            [...nameSnapshot.docs, ...codeSnapshot.docs].forEach(doc => users.set(doc.id, doc.data()));

            resultsDiv.innerHTML = '';
            if (users.size === 0) { resultsDiv.innerHTML = 'No se encontraron usuarios.'; return; }
            
            users.forEach(user => {
                if (user.uid === currentUser.uid) return;
                const userEl = document.createElement('div');
                userEl.innerHTML = `${user.username} <button data-uid="${user.uid}">A√±adir</button>`;
                resultsDiv.appendChild(userEl);
            });
        });
        
        document.getElementById('friend-search-results').addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON') {
                const friendUid = e.target.dataset.uid;
                e.target.disabled = true;
                e.target.innerText = "Enviado";
                await db.collection('friend_requests').add({ from: currentUser.uid, to: friendUid, status: 'pending', createdAt: fieldValue.serverTimestamp() });
                showModal('success-popup', 'Solicitud de amistad enviada.');
            }
        });

        // Chat
        document.getElementById('chat-input-area').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text === '' || !currentChatInfo.chatId) return;

            input.value = '';
            await db.collection('chats').doc(currentChatInfo.chatId).collection('messages').add({
                text: text,
                senderId: currentUser.uid,
                receiverId: currentChatInfo.uid,
                timestamp: fieldValue.serverTimestamp()
            });
        });
        
        // --- REAL-TIME LISTENERS ---
        function listenForFriendRequests(uid) {
            friendRequestListener = db.collection('friend_requests').where('to', '==', uid).where('status', '==', 'pending')
                .onSnapshot(async (snapshot) => {
                    notificationBadge.style.display = snapshot.empty ? 'none' : 'block';
                    const listDiv = document.getElementById('notifications-list');
                    listDiv.innerHTML = snapshot.empty ? '<p>No tienes notificaciones nuevas.</p>' : '';
                    
                    for (const doc of snapshot.docs) {
                        const request = doc.data();
                        const fromUser = await db.collection('users').doc(request.from).get();
                        const fromUsername = fromUser.data().username;
                        
                        const reqEl = document.createElement('div');
                        reqEl.innerHTML = `<span><b>${fromUsername}</b> te envi√≥ una solicitud.</span> <div><button class="accept" data-id="${doc.id}" data-from="${request.from}">Aceptar</button><button class="reject" data-id="${doc.id}">Rechazar</button></div>`;
                        listDiv.appendChild(reqEl);
                    }
                });
        }
        
        document.getElementById('notifications-list').addEventListener('click', async (e) => {
            const reqId = e.target.dataset.id;
            if (!reqId) return;
            const reqRef = db.collection('friend_requests').doc(reqId);

            if (e.target.matches('.accept')) {
                const fromUid = e.target.dataset.from;
                await db.collection('users').doc(currentUser.uid).collection('friends').doc(fromUid).set({ friendSince: fieldValue.serverTimestamp() });
                await db.collection('users').doc(fromUid).collection('friends').doc(currentUser.uid).set({ friendSince: fieldValue.serverTimestamp() });
                await reqRef.delete();
            }
            if (e.target.matches('.reject')) {
                await reqRef.delete();
            }
        });

        function listenForFriends(uid) {
            friendsListener = db.collection('users').doc(uid).collection('friends').onSnapshot(async (snapshot) => {
                const chatListUl = document.getElementById('chat-list');
                chatListUl.innerHTML = '';
                document.getElementById('no-friends-message').style.display = snapshot.empty ? 'block' : 'none';

                for (const doc of snapshot.docs) {
                    const friendData = (await db.collection('users').doc(doc.id).get()).data();
                    const li = document.createElement('li');
                    li.className = 'glass-effect';
                    li.textContent = friendData.username;
                    li.dataset.uid = friendData.uid;
                    li.dataset.username = friendData.username;
                    chatListUl.appendChild(li);
                }
            });
        }
        
        document.getElementById('chat-list').addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const { uid, username } = e.target.dataset;
                openChat(uid, username);
            }
        });

        function openChat(friendUid, friendUsername) {
            const chatId = [currentUser.uid, friendUid].sort().join('_');
            currentChatInfo = { uid: friendUid, username: friendUsername, chatId };
            
            document.getElementById('chat-friend-username').innerText = friendUsername;
            showScreen('chat-screen');

            db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp')
                .onSnapshot(snapshot => {
                    const messagesDiv = document.getElementById('chat-messages');
                    messagesDiv.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const el = document.createElement('div');
                        el.classList.add('message', msg.senderId === currentUser.uid ? 'sent' : 'received');
                        if(msg.senderId !== currentUser.uid) el.classList.add('glass-effect');
                        el.innerText = msg.text;
                        messagesDiv.appendChild(el);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
        }
        
        // --- WebRTC LOGIC ---
        function listenForIncomingCalls(uid) {
            incomingCallListener = db.collection('calls').where('callee', '==', uid).where('status', '==', 'ringing')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const callData = change.doc.data();
                            const callId = change.doc.id;
                            const callerInfo = await db.collection('users').doc(callData.caller).get();
                            document.getElementById('incoming-call-text').innerText = `${callerInfo.data().username} te est√° llamando...`;
                            document.getElementById('answer-call-btn').onclick = () => answerCall(callId, callData);
                            document.getElementById('reject-call-btn').onclick = () => rejectCall(callId);
                            showModal('incoming-call-modal');
                        }
                    });
                });
        }
        
        ['voice-call-btn', 'video-call-btn'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                if(currentChatInfo.uid) {
                    const isVideo = e.currentTarget.id === 'video-call-btn';
                    initiateCall(currentChatInfo.uid, isVideo);
                } else {
                    alert("Abre un chat para poder llamar a alguien.");
                }
            });
        });

        async function initiateCall(friendId, isVideo) {
            peerConnection = new RTCPeerConnection(servers);
            registerPeerConnectionListeners();
            localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            const callDoc = db.collection('calls').doc();
            const offerCandidates = callDoc.collection('offerCandidates');
            const answerCandidates = callDoc.collection('answerCandidates');
            
            peerConnection.onicecandidate = event => event.candidate && offerCandidates.add(event.candidate.toJSON());
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            await callDoc.set({ offer, caller: currentUser.uid, callee: friendId, status: 'ringing' });

            document.getElementById('video-call-container').style.display = 'block';

            callDoc.onSnapshot(async (snapshot) => {
                const data = snapshot.data();
                if (!peerConnection.currentRemoteDescription && data?.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
                if (data?.status === 'ended' || data?.status === 'rejected') {
                    endCall();
                }
            });

            answerCandidates.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
        }
        
        async function answerCall(callId, callData) {
            hideModals();
            peerConnection = new RTCPeerConnection(servers);
            registerPeerConnectionListeners();
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            const callDoc = db.collection('calls').doc(callId);
            const answerCandidates = callDoc.collection('answerCandidates');
            peerConnection.onicecandidate = event => event.candidate && answerCandidates.add(event.candidate.toJSON());

            await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await callDoc.update({ answer, status: 'connected' });
            document.getElementById('video-call-container').style.display = 'block';

            callDoc.collection('offerCandidates').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
        }
        
        async function rejectCall(callId) {
            await db.collection('calls').doc(callId).update({ status: 'rejected' });
            hideModals();
        }

        function endCall() {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (peerConnection) peerConnection.close();
            document.getElementById('video-call-container').style.display = 'none';
            peerConnection = null;
            hideModals();
        }
        
        document.getElementById('end-call-btn').addEventListener('click', endCall);
        
        function registerPeerConnectionListeners() {
            peerConnection.addEventListener('track', event => {
                document.getElementById('remote-video').srcObject = event.streams[0];
            });
        }

    </script>
</body>
</html>
